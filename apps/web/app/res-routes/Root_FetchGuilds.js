// Generated by ReScript, PLEASE EDIT WITH CARE

import * as $$Promise from "../../../../node_modules/@ryyppy/rescript-promise/src/Promise.js";
import * as AuthServer from "../AuthServer.js";
import * as DiscordServer from "../DiscordServer.js";

function loader(param) {
  return $$Promise.$$catch(AuthServer.authenticator.isAuthenticated(param.request).then(function (user) {
                  if (user == null) {
                    return Promise.resolve({
                                user: null,
                                guilds: [],
                                rateLimited: false
                              });
                  } else {
                    return DiscordServer.fetchUserGuilds(user).then(function (userGuilds) {
                                return DiscordServer.fetchBotGuilds(undefined, undefined, undefined).then(function (botGuilds) {
                                            var guilds = userGuilds.filter(function (userGuild) {
                                                  return botGuilds.findIndex(function (botGuild) {
                                                              return botGuild.id === userGuild.id;
                                                            }) !== -1;
                                                });
                                            return Promise.resolve({
                                                        user: null,
                                                        guilds: guilds,
                                                        rateLimited: false
                                                      });
                                          });
                              });
                  }
                }), (function (error) {
                if (error.RE_EXN_ID === DiscordServer.DiscordRateLimited) {
                  return Promise.resolve({
                              user: null,
                              guilds: [],
                              rateLimited: true
                            });
                } else {
                  return Promise.resolve({
                              user: null,
                              guilds: [],
                              rateLimited: false
                            });
                }
              }));
}

export {
  loader ,
  
}
/* AuthServer Not a pure module */
