// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Env = require("./Env.bs.js");
var Curry = require("rescript/lib/js/curry.js");
var Dotenv = require("dotenv");
var DiscordJs = require("discord.js");
var Caml_exceptions = require("rescript/lib/js/caml_exceptions.js");
var Parser_DetectHandler = require("./parser/Parser_DetectHandler.bs.js");
var UpdateOrReadGistJs = require("./updateOrReadGist.js");
var WhitelistedChannels = require("./parser/whitelistedChannels");

var RequestHandlerError = /* @__PURE__ */Caml_exceptions.create("Bot.RequestHandlerError");

function parseWhitelistedChannels(prim) {
  return WhitelistedChannels();
}

function updateGist(prim0, prim1) {
  return UpdateOrReadGistJs.updateGist(prim0, prim1);
}

Dotenv.config({
      path: "../../.env"
    });

var config = Env.getConfig(undefined);

var client = new DiscordJs.Client(undefined);

function checkWhitelistedChannel(message) {
  var channel = message.channel;
  var whitelistedChannels = WhitelistedChannels();
  var messageWhitelisted = whitelistedChannels.reduce((function (whitelisted, name) {
          if (name === channel.name || name === "*") {
            return true;
          } else {
            return whitelisted;
          }
        }), false);
  if (messageWhitelisted) {
    return false;
  } else {
    return whitelistedChannels.length !== 0;
  }
}

function updateGistOnGuildCreate(guild) {
  return UpdateOrReadGistJs.updateGist(guild.id, {
              name: guild.name,
              role: "Verified"
            });
}

function onGuildCreate(guild) {
  var roleManager = guild.roles;
  var createRoleOptions = {
    data: {
      name: "Verified",
      color: "ORANGE"
    },
    reason: "Verify users with BrightID"
  };
  roleManager.create(createRoleOptions);
  updateGistOnGuildCreate(guild);
  
}

function onMessage(message) {
  var author = message.author;
  var isBot = author.bot;
  if (isBot) {
    return ;
  }
  if (checkWhitelistedChannel(message)) {
    return ;
  }
  var guildMember = message.member;
  var handler = Parser_DetectHandler.detectHandler(message);
  if (handler !== undefined) {
    Curry._3(handler, guildMember, client, message);
  } else {
    message.reply("Could not find the requested command");
    console.error({
          RE_EXN_ID: RequestHandlerError,
          date: Date.now(),
          message: "Could not find the requested command"
        });
  }
  
}

client.on("ready", (function (param) {
        console.log("Logged In");
        
      }));

client.on("guildCreate", onGuildCreate);

client.on("message", onMessage);

if (config.TAG === /* Ok */0) {
  client.login(config._0.discordApiToken);
} else {
  console.log(config._0);
}

exports.RequestHandlerError = RequestHandlerError;
exports.parseWhitelistedChannels = parseWhitelistedChannels;
exports.updateGist = updateGist;
exports.config = config;
exports.client = client;
exports.checkWhitelistedChannel = checkWhitelistedChannel;
exports.updateGistOnGuildCreate = updateGistOnGuildCreate;
exports.onGuildCreate = onGuildCreate;
exports.onMessage = onMessage;
/*  Not a pure module */
