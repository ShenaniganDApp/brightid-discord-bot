// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Js_dict from "../../../../node_modules/rescript/lib/es6/js_dict.js";
import * as $$Promise from "../../../../node_modules/@ryyppy/rescript-promise/src/Promise.mjs";
import * as Belt_Array from "../../../../node_modules/rescript/lib/es6/belt_Array.js";
import * as Caml_option from "../../../../node_modules/rescript/lib/es6/caml_option.js";
import * as Caml_exceptions from "../../../../node_modules/rescript/lib/es6/caml_exceptions.js";
import * as UpdateOrReadGistMjs from "../updateOrReadGist.mjs";

var RoleHandlerError = /* @__PURE__ */Caml_exceptions.create("Handlers_Role.RoleHandlerError");

function updateGist(prim0, prim1) {
  return UpdateOrReadGistMjs.updateGist(prim0, prim1);
}

function readGist(prim) {
  return UpdateOrReadGistMjs.readGist();
}

var newRoleRe = /(?<=^\S+)\s/;

function getRolebyRoleName(guildRoleManager, roleName) {
  var guildRole = guildRoleManager.cache.find(function (role) {
        return role.name === roleName;
      });
  if (!(guildRole == null)) {
    return guildRole;
  }
  throw {
        RE_EXN_ID: RoleHandlerError,
        _1: "Could not find a role with the name " + roleName,
        Error: new Error()
      };
}

function role(member, param, message) {
  var guild = member.guild;
  var guildRoleManager = guild.roles;
  var tmp;
  if (member.hasPermission("ADMINISTRATOR")) {
    var role$1 = message.content.split(newRoleRe);
    var role$2 = Belt_Array.get(role$1, 1);
    if (role$2 !== undefined) {
      var role$3 = Caml_option.valFromOption(role$2);
      tmp = role$3 !== undefined ? UpdateOrReadGistMjs.readGist().then(function (guilds) {
              var guildId = guild.id;
              var guildData = Js_dict.get(guilds, guildId);
              if (guildData !== undefined) {
                var previousRole = guildData.role;
                var guildRole = getRolebyRoleName(guildRoleManager, previousRole);
                return guildRole.edit({
                                name: role$3
                              }, "Update BrightId role name").then(function (param) {
                              return UpdateOrReadGistMjs.updateGist(guildId, {
                                          role: role$3
                                        });
                            }).then(function (param) {
                            message.reply("Succesfully update verified role to `" + role$3 + "`");
                            return Promise.resolve(message);
                          });
              }
              message.reply("Failed to retreive role data for guild");
              return Promise.reject({
                          RE_EXN_ID: RoleHandlerError,
                          _1: "Guild does not exist"
                        });
            }) : Promise.reject({
              RE_EXN_ID: RoleHandlerError,
              _1: "Role is empty"
            });
    } else {
      message.reply("Please specify a role -> `!role <role>`");
      tmp = Promise.reject({
            RE_EXN_ID: RoleHandlerError,
            _1: "No role specified"
          });
    }
  } else {
    message.reply("Must be an administrator");
    tmp = Promise.reject({
          RE_EXN_ID: RoleHandlerError,
          _1: "Administrator permissions are required"
        });
  }
  return $$Promise.$$catch(tmp, (function (e) {
                if (e.RE_EXN_ID === RoleHandlerError) {
                  console.error(e._1);
                } else if (e.RE_EXN_ID === $$Promise.JsError) {
                  var msg = e._1.message;
                  if (msg !== undefined) {
                    console.error(msg);
                  } else {
                    console.error("Must be some non-error value");
                  }
                } else {
                  console.error("Some unknown error");
                }
                return Promise.resolve(message);
              }));
}

export {
  RoleHandlerError ,
  updateGist ,
  readGist ,
  newRoleRe ,
  getRolebyRoleName ,
  role ,
  
}
/* ../updateOrReadGist.mjs Not a pure module */
